#!/usr/bin/env node
(()=>{var e={569:(e,r,n)=>{e.exports=n(325)},325:(e,r,n)=>{"use strict";var t=n(129).exec;var s=n(129).execSync;var o=n(747);var c=n(622);var i=o.access;var a=o.accessSync;var u=o.constants||o;var l=process.platform=="win32";var fileNotExists=function(e,r){i(e,u.F_OK,(function(e){r(!e)}))};var fileNotExistsSync=function(e){try{a(e,u.F_OK);return false}catch(e){return true}};var localExecutable=function(e,r){i(e,u.F_OK|u.X_OK,(function(e){r(null,!e)}))};var localExecutableSync=function(e){try{a(e,u.F_OK|u.X_OK);return true}catch(e){return false}};var commandExistsUnix=function(e,r,n){fileNotExists(e,(function(s){if(!s){var o=t("command -v "+r+" 2>/dev/null"+" && { echo >&1 "+r+"; exit 0; }",(function(e,r,t){n(null,!!r)}));return}localExecutable(e,n)}))};var commandExistsWindows=function(e,r,n){if(!/^(?!(?:.*\s|.*\.|\W+)$)(?:[a-zA-Z]:)?(?:(?:[^<>:"\|\?\*\n])+(?:\/\/|\/|\\\\|\\)?)+$/m.test(e)){n(null,false);return}var s=t("where "+r,(function(e){if(e!==null){n(null,false)}else{n(null,true)}}))};var commandExistsUnixSync=function(e,r){if(fileNotExistsSync(e)){try{var n=s("command -v "+r+" 2>/dev/null"+" && { echo >&1 "+r+"; exit 0; }");return!!n}catch(e){return false}}return localExecutableSync(e)};var commandExistsWindowsSync=function(e,r,n){if(!/^(?!(?:.*\s|.*\.|\W+)$)(?:[a-zA-Z]:)?(?:(?:[^<>:"\|\?\*\n])+(?:\/\/|\/|\\\\|\\)?)+$/m.test(e)){return false}try{var t=s("where "+r,{stdio:[]});return!!t}catch(e){return false}};var cleanInput=function(e){if(/[^A-Za-z0-9_\/:=-]/.test(e)){e="'"+e.replace(/'/g,"'\\''")+"'";e=e.replace(/^(?:'')+/g,"").replace(/\\'''/g,"\\'")}return e};if(l){cleanInput=function(e){var r=/[\\]/.test(e);if(r){var n='"'+c.dirname(e)+'"';var t='"'+c.basename(e)+'"';return n+":"+t}return'"'+e+'"'}}e.exports=function commandExists(e,r){var n=cleanInput(e);if(!r&&typeof Promise!=="undefined"){return new Promise((function(r,n){commandExists(e,(function(t,s){if(s){r(e)}else{n(t)}}))}))}if(l){commandExistsWindows(e,n,r)}else{commandExistsUnix(e,n,r)}};e.exports.sync=function(e){var r=cleanInput(e);if(l){return commandExistsWindowsSync(e,r)}else{return commandExistsUnixSync(e,r)}}},748:(e,r,n)=>{const{exec:t,execSync:s}=n(129);const o={run:runCommand,runSync:runSync,get:runCommand};function runCommand(e,r){return t(e,function(){return function(e,n,t){if(!r)return;r(e,n,t)}}(r))}function runSync(e){try{return{data:s(e).toString(),err:null,stderr:null}}catch(e){return{data:null,err:e.stderr.toString(),stderr:e.stderr.toString()}}}e.exports=o},898:(e,r,n)=>{"use strict";var t=n(129).spawn;var s=n(669);var escapeSpaces=function(e){if(typeof e==="string"){return e.replace(/\b\s/g,"\\ ")}else{return e}};var escapeSpacesInOptions=function(e){["src","dest","include","exclude","excludeFirst"].forEach((function(r){var n=e[r];if(typeof n==="string"){e[r]=escapeSpaces(n)}else if(Array.isArray(n)===true){e[r]=n.map(escapeSpaces)}}));return e};e.exports=function(e,r){e=e||{};e=s._extend({},e);e=escapeSpacesInOptions(e);var n=e.platform||process.platform;var o=n==="win32";if(typeof e.src==="undefined"){throw new Error("'src' directory is missing from options")}if(typeof e.dest==="undefined"){throw new Error("'dest' directory is missing from options")}var c=e.dest;if(typeof e.host!=="undefined"){c=e.host+":"+e.dest}if(!Array.isArray(e.src)){e.src=[e.src]}var i=[].concat(e.src);i.push(c);var a=(e.args||[]).find((function(e){return e.match(/--chmod=/)}));if(o&&!a){i.push("--chmod=ugo=rwX")}if(typeof e.host!=="undefined"||e.ssh){i.push("--rsh");var u="ssh";if(typeof e.port!=="undefined"){u+=" -p "+e.port}if(typeof e.privateKey!=="undefined"){u+=" -i "+e.privateKey}if(typeof e.sshCmdArgs!=="undefined"){u+=" "+e.sshCmdArgs.join(" ")}i.push(u)}if(e.recursive===true){i.push("--recursive")}if(e.times===true){i.push("--times")}if(e.syncDest===true||e.deleteAll===true){i.push("--delete");i.push("--delete-excluded")}if(e.syncDestIgnoreExcl===true||e.delete===true){i.push("--delete")}if(e.dryRun===true){i.push("--dry-run");i.push("--verbose")}if(typeof e.excludeFirst!=="undefined"&&s.isArray(e.excludeFirst)){e.excludeFirst.forEach((function(e,r){i.push("--exclude="+e)}))}if(typeof e.include!=="undefined"&&s.isArray(e.include)){e.include.forEach((function(e,r){i.push("--include="+e)}))}if(typeof e.exclude!=="undefined"&&s.isArray(e.exclude)){e.exclude.forEach((function(e,r){i.push("--exclude="+e)}))}switch(e.compareMode){case"sizeOnly":i.push("--size-only");break;case"checksum":i.push("--checksum");break}if(typeof e.args!=="undefined"&&s.isArray(e.args)){i=[...new Set([...i,...e.args])]}i=[...new Set(i)];var noop=function(){};var l=e.onStdout||noop;var d=e.onStderr||noop;var f="rsync ";i.forEach((function(e){if(e.substr(0,4)==="ssh "){e='"'+e+'"'}f+=e+" "}));f=f.trim();if(e.noExec){r(null,null,null,f);return}try{var p="";var y="";var v;if(o){v=t("cmd.exe",["/s","/c",'"'+f+'"'],{windowsVerbatimArguments:true,stdio:[process.stdin,"pipe","pipe"]})}else{v=t("/bin/sh",["-c",f])}v.stdout.on("data",(function(e){l(e);p+=e}));v.stderr.on("data",(function(e){d(e);y+=e}));v.on("exit",(function(e){var n=null;if(e!==0){n=new Error("rsync exited with code "+e);n.code=e}r(n,p,y,f)}))}catch(e){r(e,null,null,f)}}},505:(e,r,n)=>{const{existsSync:t,mkdirSync:s,writeFileSync:o}=n(747);const{GITHUB_WORKSPACE:c}=process.env;const validateDir=e=>{if(!t(e)){console.log(`[SSH] Creating ${e} dir in `,c);s(e);console.log("✅ [SSH] dir created.")}else{console.log(`[SSH] ${e} dir exist`)}};const validateFile=e=>{if(!t(e)){console.log(`[SSH] Creating ${e} file in `,c);try{o(e,"",{encoding:"utf8",mode:384});console.log("✅ [SSH] file created.")}catch(r){console.error("⚠️ [SSH] writeFileSync error",e,r.message);process.abort()}}else{console.log(`[SSH] ${e} file exist`)}};e.exports={validateDir:validateDir,validateFile:validateFile}},229:e=>{const r=["SSH_CONFIG","SSH_PRIVATE_KEY","SOURCE","TARGET","ARGS","EXCLUDE"];const n={GITHUB_WORKSPACE:process.env.GITHUB_WORKSPACE};r.forEach((e=>{n[e]=process.env[e]||process.env[`INPUT_${e}`]}));e.exports=n},447:(e,r,n)=>{const{sync:t}=n(569);const{get:s}=n(748);const validateRsync=(e=(()=>{}))=>{const r=t("rsync");if(!r){s("sudo apt-get --no-install-recommends install rsync",((r,n,t)=>{if(r){console.log("⚠️ [CLI] Rsync installation failed. Aborting ... ",r.message);process.abort()}else{console.log("✅ [CLI] Rsync installed. \n",n,t);e()}}))}else{e()}};const validateInputs=e=>{const r=Object.keys(e);const n=r.filter((r=>{const n=e[r];if(!n){console.error(`⚠️ [INPUTS] ${r} is mandatory`)}return n}));if(n.length!==r.length){console.error("⚠️ [INPUTS] Inputs not valid, aborting ...");process.abort()}};e.exports={validateRsync:validateRsync,validateInputs:validateInputs}},822:(e,r,n)=>{const{writeFileSync:t}=n(747);const{join:s}=n(622);const{validateDir:o,validateFile:c}=n(505);const{HOME:i}=process.env;const a="id_github_ci";const u=s(i||__dirname,".ssh");function makeConfig(e){return e.replace("{TARGET}","DeployTarget").replace("{IDENTITY_FILE}",s(u,a))}const addSshConfig=(e,r)=>{const n=s(u,a);const i=s(u,"config");o(u);c(s(u,"known_hosts"));try{t(i,makeConfig(e),{encoding:"utf8",mode:384})}catch(e){console.error("⚠️ writeFileSync error",i,e.message);process.abort()}console.log("✅ Ssh config added to `.ssh` dir ",i);try{t(n,r,{encoding:"utf8",mode:384})}catch(e){console.error("⚠️ writeFileSync error",n,e.message);process.abort()}console.log("✅ Ssh key added to `.ssh` dir ",n)};e.exports={addSshConfig:addSshConfig}},129:e=>{"use strict";e.exports=require("child_process")},747:e=>{"use strict";e.exports=require("fs")},622:e=>{"use strict";e.exports=require("path")},669:e=>{"use strict";e.exports=require("util")}};var r={};function __nccwpck_require__(n){var t=r[n];if(t!==undefined){return t.exports}var s=r[n]={exports:{}};var o=true;try{e[n](s,s.exports,__nccwpck_require__);o=false}finally{if(o)delete r[n]}return s.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var n={};(()=>{const e=__nccwpck_require__(898);const{validateRsync:r,validateInputs:n}=__nccwpck_require__(447);const{addSshConfig:t}=__nccwpck_require__(822);const{SSH_CONFIG:s,SSH_PRIVATE_KEY:o,SOURCE:c,TARGET:i,ARGS:a,EXCLUDE:u,GITHUB_WORKSPACE:l}=__nccwpck_require__(229);const d={ssh:true,sshCmdArgs:["-o StrictHostKeyChecking=no"],recursive:true};console.log("[general] GITHUB_WORKSPACE: ",l);const f=(()=>{const rsync=({src:r,dest:n,args:t,exclude:s})=>{console.log(`[Rsync] Starting Rsync Action: ${r} to ${n}`);if(s)console.log(`[Rsync] exluding folders ${s}`);try{e({src:r,dest:`DeployTarget:${n}`,args:t,excludeFirst:s,...d},((e,r,n,t)=>{if(e){console.error("⚠️ [Rsync] error: ",e.message);console.log("⚠️ [Rsync] stderr: ",n);console.log("⚠️ [Rsync] stdout: ",r);console.log("⚠️ [Rsync] cmd: ",t);process.abort()}else{console.log("✅ [Rsync] finished.",r)}}))}catch(e){console.error("⚠️ [Rsync] command error: ",e.message,e.stack);process.abort()}};const init=({src:e,dest:n,args:s,config:o,privateKeyContent:c,exclude:i=[]})=>{r((()=>{t(o,c);rsync({src:e,dest:n,args:s,exclude:i})}))};return{init:init}})();const run=()=>{n({SSH_PRIVATE_KEY:o,SSH_CONFIG:s});f.init({src:`${l}/${c||""}`,dest:i||"",args:a?[a]:["-rltgoDzvO"],config:s,privateKeyContent:o,exclude:(u||"").split(",").map((e=>e.trim()))})};run()})();module.exports=n})();